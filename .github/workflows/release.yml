name: Release

permissions:
  contents: write
  checks: write

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  # Run the full test suite first
  test:
    name: Run Test Suite
    uses: ./.github/workflows/test.yml
    permissions:
      checks: write
      contents: read

  # Only create release if tests pass
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: test  # Wait for test workflow to complete successfully

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Extract version from tag
        id: get_version
        run: |
          # Remove 'v' prefix from tag (e.g., v1.0.0 -> 1.0.0)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Extract release notes from CHANGELOG
        id: changelog
        run: |
          # Extract the section for this version from CHANGELOG.md
          VERSION="${{ steps.get_version.outputs.tag }}"

          # Use awk to extract the section between this version and the next
          awk -v version="## $VERSION" '
            $0 ~ version { found=1; next }
            found && /^## v/ { exit }
            found { print }
          ' CHANGELOG.md > release_notes.md

          # If release notes are empty, add a placeholder
          if [ ! -s release_notes.md ]; then
            echo "Release $VERSION" > release_notes.md
            echo "" >> release_notes.md
            echo "See [CHANGELOG.md](CHANGELOG.md) for details." >> release_notes.md
          fi

          # Show what we extracted (for debugging)
          echo "=== Release Notes ==="
          cat release_notes.md
          echo "===================="

      - name: Build package
        run: |
          echo "Building Python package..."
          uv build

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.get_version.outputs.tag }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            dist/*.whl
            dist/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to PyPI
        if: github.repository == 'pcaro90/twcaldav'
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          if [ -n "$UV_PUBLISH_TOKEN" ]; then
            echo "Publishing to PyPI..."
            uv publish
          else
            echo "⚠️  PYPI_API_TOKEN not set, skipping PyPI publish"
          fi
