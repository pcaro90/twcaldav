services:
  radicale:
    image: tomsquest/docker-radicale:latest
    container_name: twcaldav-radicale-test
    ports:
      - "5232:5232"
    networks:
      - twcaldav-test
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5232"]
      interval: 10s
      timeout: 5s
      retries: 5
    attach: false

  test-runner:
    image: ubuntu:22.04
    container_name: twcaldav-test-runner
    depends_on:
      radicale:
        condition: service_healthy
    environment:
      - CALDAV_URL=http://radicale:5232/test-user/
      - CALDAV_USERNAME=test-user
      - CALDAV_PASSWORD=test-pass
      - CALDAV_CALENDAR_ID=test-calendar
      - TW_PROJECT=test
      - TASKDATA=/tmp/taskwarrior-test
      - DEBIAN_FRONTEND=noninteractive
      - UV_PROJECT_ENVIRONMENT=/tmp/uv-env
    volumes:
      - ./:/app
      - taskdata:/tmp/taskwarrior-test
    working_dir: /app
    networks:
      - twcaldav-test
    command: >
      bash -c "
        set -e
        echo '=== Setting up test environment ===' &&
        apt-get update -qq >/dev/null &&
        apt-get install -y -qq taskwarrior curl ca-certificates >/dev/null &&
        curl -LsSf https://astral.sh/uv/install.sh | sh &&
        export PATH=\"/root/.local/bin:\$PATH\" &&
        echo '=== Installing dependencies ===' &&
        uv sync --all-extras >/dev/null &&
        echo '=== Initializing TaskWarrior ===' &&
        mkdir -p /tmp/taskwarrior-test &&
        task rc.data.location=/tmp/taskwarrior-test rc.confirmation=off version &&
        echo '=== Waiting for Radicale ===' &&
        sleep 5 &&
        echo '=== Setting up Radicale test data ===' &&
        bash scripts/setup-radicale-test-data.sh &&
        echo '=== Running integration tests ===' &&
        uv run pytest tests/integration -v --tb=short --junit-xml=/app/test-results.xml
      "

networks:
  twcaldav-test:
    driver: bridge

volumes:
  taskdata:
