version: '3.8'

services:
  radicale:
    image: tomsquest/docker-radicale:latest
    container_name: twcaldav-radicale-test
    ports:
      - "5232:5232"
    networks:
      - twcaldav-test
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5232"]
      interval: 10s
      timeout: 5s
      retries: 5

  test-runner:
    image: ubuntu:22.04
    container_name: twcaldav-test-runner
    depends_on:
      radicale:
        condition: service_healthy
    environment:
      - CALDAV_URL=http://radicale:5232/test-user/
      - CALDAV_USERNAME=test-user
      - CALDAV_PASSWORD=test-pass
      - CALDAV_CALENDAR_ID=test-calendar
      - TW_PROJECT=test
      - TASKDATA=/tmp/taskwarrior-test
      - DEBIAN_FRONTEND=noninteractive
    volumes:
      - ./:/app
      - taskdata:/tmp/taskwarrior-test
    working_dir: /app
    networks:
      - twcaldav-test
    command: >
      bash -c "
        set -e
        echo '=== Setting up test environment ===' &&
        apt-get update -qq &&
        apt-get install -y -qq taskwarrior curl ca-certificates &&
        curl -LsSf https://astral.sh/uv/install.sh | sh &&
        export PATH=\"/root/.local/bin:\$PATH\" &&
        echo '=== Installing dependencies ===' &&
        uv sync --all-extras &&
        echo '=== Initializing TaskWarrior ===' &&
        mkdir -p /tmp/taskwarrior-test &&
        task rc.data.location=/tmp/taskwarrior-test rc.confirmation=off version &&
        echo '=== Waiting for Radicale ===' &&
        sleep 5 &&
        echo '=== Setting up Radicale test data ===' &&
        bash scripts/setup-radicale-test-data.sh &&
        echo '=== Running integration tests ===' &&
        uv run python tests/integration/test_e2e.py
      "

networks:
  twcaldav-test:
    driver: bridge

volumes:
  taskdata:
